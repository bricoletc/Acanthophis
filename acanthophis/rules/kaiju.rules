rule kaiju:
    input:
        reads=P("reads/samples/{sample}.fastq.gz"),
        taxon=lambda wc: R(config["data_paths"]["kaiju"][wc.db]["nodes"], keep_local=True),
        index=lambda wc: R(config["data_paths"]["kaiju"][wc.db]["fmi"], keep_local=True),
    output:
        P("taxonid/{sampleset}/kaiju/{db}/{sample}.txt"),
    log: L("taxonid/{sampleset}/kaiju/{db}/{sample}.log"),
    resources: **rule_resources(config, "kaiju", time_min=90, mem_gb=32, disk_gb=24, cores=4)
    conda: "envs/kaiju.yml"
    shell:
        "kaiju"
        "   -t {input.taxon}"
        "   -f {input.index}"
        "   -o {output}"
        "   -z {threads}"
        "   -i {input.reads}"
        "   >{log} 2>&1"



rule all_kaiju:
    input:
        [P(expand("taxonid/{sampleset}/kaiju/{db}/{sample}.txt",
                  sampleset=sampleset,
                  sample=config["SAMPLESETS"][sampleset],
                  db=config["samplesets"][sampleset]["kaiju_dbs"],
                  ))
         for sampleset in config["samplesets"]
         if "kaiju_dbs" in config["samplesets"][sampleset]
        ],
